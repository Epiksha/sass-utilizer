@use 'sass:map';
@use 'sass:list';
@use 'sass:string';
@use 'sass:selector';
@use '_globals.scss';

@function get($keys...) {
    @if list.length($keys) {
        @return globals.get(config, $keys...);
    } @else {
        @return globals.get(config);
    }
}

@mixin set($setting, $value, $isGlobal: false) {
    $mapKeys: config, utility;
    $type: utility;

    @if $isGlobal {
        $mapKeys: config, global;
        $type: global;
    }

    $keys: list.join($mapKeys, ($setting, $value));

    // Check if config label is valid and if so, set it to current setting
    @if map.has-key(globals.get($mapKeys...), $setting) {
        $configProperty: globals.get(list.join($mapKeys, $setting)...);

        @if $configProperty {
            @each $tempKey, $tempValue in $configProperty {
                @if $tempValue != null and $tempValue != $value {
                    $newMap: $value;

                    // Remove any property that might overwrite an existing property
                    @each $key in map-keys($value) {
                        @if map.has-key($newMap, $tempKey) {
                            $newMap: map.remove($newMap, $key);
                        }
                    }

                    @include globals.merge(list.join($mapKeys, ($setting, $newMap))...);
                }
            }
        } @else {
            @include globals.set($keys...);
        }
    } @else {
        @error 'Sass Utilizer: Invalid setting \'#{$setting}\' in \'#{$type}\' config SET method';
    }

    // Use defaults from global if utility's config property equals null
    @each $configLabel, $configValue in globals.get(config, global, defaults) {
        @if globals.get(config, utility, $configLabel) == null {
            @include globals.set(config, utility, $configLabel, $configValue);
        }
    }
}

// Set config (located in globals file)
@mixin setup($utilities, $config) {
    // Setup global config
    @each $setting, $value in $config {
        @include set($setting, $value, true);
    }
    
    // Setup utility-specific config
    @if $utilities {
        @each $utilityLabel, $utility in $utilities {
            $selector: '#{$utilityLabel}';

            // Build out config
            @each $setting, $value in $utility {
                @if $setting == aliases {
                    @each $alias in $value {
                        $selector: string.insert($selector, ', #{$alias}', string.length($selector) + 1);
                    }
                } @else {
                    @include set($setting, $value);
                }
            }

            // Setup blueprints
            @if globals.get(config, utility, blueprints) {
                @each $blueprint in globals.get(config, utility, blueprints) {
                    @if globals.get(config, global, blueprints, $blueprint) {
                        @each $setting, $value in globals.get(config, global, blueprints, $blueprint) {
                            @include set($setting, $value);
                        } 
                    } @else {
                        @warn 'Sass Utilizer: Blueprint \'#{$blueprint}\' in utility \'#{$utilityLabel}\' is not defined';
                    }
                }
            }

            // Add formatted utility to global utilities (will generate identical utilities for every alias)
            $formattedSettings: ();

            @each $setting, $value in get(utility) {
                @if $value != null {
                    $formattedSettings: map.merge($formattedSettings, ($setting: $value));
                }
            }

            @include globals.merge(utilities, $selector, $formattedSettings);

            // Reset global utility-specific config for next utility
            @include globals.reset-utility-config();
        }
    } @else {
        @error 'Sass Utilizer: No utilities passed into utilizer';
    }
}
